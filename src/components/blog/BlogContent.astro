---
// src/components/blog/BlogContent.astro
// Created: Blog content renderer with prose styling

interface Props {
  content: string;
}

const { content } = Astro.props;

// Simple markdown-like parser (for demo purposes)
// In production, use a proper markdown parser like marked or remark
function parseContent(rawContent: string): string {
  let html = rawContent;

  // Headers
  html = html.replace(/^### (.*$)/gm, '<h3 id="$1" class="scroll-mt-24">$1</h3>');
  html = html.replace(/^## (.*$)/gm, '<h2 id="$1" class="scroll-mt-24">$1</h2>');

  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Code blocks
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
    return `<pre class="language-${lang || 'plaintext'}"><code>${code.trim()}</code></pre>`;
  });

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Tables
  html = html.replace(/\|(.+)\|\n\|[-\s|]+\|\n((?:\|.+\|\n?)+)/g, (match, header, rows) => {
    const headerCells = header.split('|').filter((c: string) => c.trim()).map((c: string) => `<th>${c.trim()}</th>`).join('');
    const bodyRows = rows.trim().split('\n').map((row: string) => {
      const cells = row.split('|').filter((c: string) => c.trim()).map((c: string) => `<td>${c.trim()}</td>`).join('');
      return `<tr>${cells}</tr>`;
    }).join('');
    return `<table><thead><tr>${headerCells}</tr></thead><tbody>${bodyRows}</tbody></table>`;
  });

  // Lists (unordered)
  html = html.replace(/^- (.*)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

  // Lists (ordered)
  html = html.replace(/^\d+\. (.*)$/gm, '<li>$1</li>');

  // Paragraphs
  html = html.split('\n\n').map(block => {
    if (block.startsWith('<') || block.trim() === '') return block;
    return `<p>${block}</p>`;
  }).join('\n');

  // Clean up multiple newlines
  html = html.replace(/\n{3,}/g, '\n\n');

  return html;
}

// Extract headings for TOC
export function extractHeadings(content: string): { id: string; text: string; level: number }[] {
  const headings: { id: string; text: string; level: number }[] = [];
  const regex = /^(#{2,3}) (.*)$/gm;
  let match;
  
  while ((match = regex.exec(content)) !== null) {
    headings.push({
      id: match[2].replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').toLowerCase(),
      text: match[2],
      level: match[1].length,
    });
  }
  
  return headings;
}

const parsedContent = parseContent(content);
---

<div class="blog-content prose prose-lg max-w-none">
  <Fragment set:html={parsedContent} />
</div>

<style is:global>
  .blog-content {
    color: var(--color-text-secondary);
    line-height: 1.8;
  }

  .blog-content h2 {
    color: var(--color-text-primary);
    font-size: 1.75rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .blog-content h3 {
    color: var(--color-text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .blog-content h4 {
    color: var(--color-text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .blog-content p {
    margin-bottom: 1.25rem;
  }

  .blog-content strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .blog-content a {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .blog-content a:hover {
    opacity: 0.8;
  }

  .blog-content ul,
  .blog-content ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .blog-content ul {
    list-style-type: disc;
  }

  .blog-content ol {
    list-style-type: decimal;
  }

  .blog-content li {
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
  }

  .blog-content li::marker {
    color: var(--color-accent);
  }

  .blog-content code {
    background-color: var(--color-bg-secondary);
    color: var(--color-accent);
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
  }

  .blog-content pre {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }

  .blog-content pre code {
    background: none;
    padding: 0;
    color: var(--color-text-primary);
    font-size: inherit;
  }

  .blog-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .blog-content th,
  .blog-content td {
    padding: 0.75rem 1rem;
    text-align: left;
    border: 1px solid var(--color-border);
  }

  .blog-content th {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .blog-content tr:nth-child(even) {
    background-color: var(--color-bg-secondary);
  }

  .blog-content blockquote {
    border-left: 4px solid var(--color-accent);
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-text-tertiary);
  }

  .blog-content hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
  }

  .blog-content img {
    border-radius: 12px;
    margin: 1.5rem 0;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .blog-content h2 {
      font-size: 1.5rem;
    }

    .blog-content h3 {
      font-size: 1.15rem;
    }

    .blog-content table {
      display: block;
      overflow-x: auto;
    }
  }
</style>